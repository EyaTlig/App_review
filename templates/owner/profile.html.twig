{% extends 'base_client.html.twig' %}

{% block title %}Profil de {{ owner.name }}{% endblock %}

{% block body %}

    <div class="container mt-4">
        <h2 class="mb-4">Propriétaire : {{ owner.name }}</h2>

        <h4 class="mb-3">Ses commerces</h4>

        <div class="row g-4">

            {% for business in businesses %}
                <div class="col-md-4">

                    <div class="card mb-3 shadow-sm h-100 business-card"
                         data-id="{{ business.id }}"
                         style="cursor:pointer;">

                        {% if business.photos|length > 0 %}
                            <div id="carouselOwner{{ business.id }}" class="carousel slide" data-bs-ride="carousel">
                                <div class="carousel-inner">
                                    {% for photo in business.photos %}
                                        <div class="carousel-item {% if loop.first %}active{% endif %}">
                                            <img src="{{ asset('uploads/business_photos/' ~ photo.filename) }}"
                                                 class="d-block w-100 carousel-img"
                                                 alt="{{ business.name }}">
                                        </div>
                                    {% endfor %}
                                </div>

                                {% if business.photos|length > 1 %}
                                    <button class="carousel-control-prev" type="button" data-bs-target="#carouselOwner{{ business.id }}" data-bs-slide="prev">
                                        <span class="carousel-control-prev-icon"></span>
                                    </button>
                                    <button class="carousel-control-next" type="button" data-bs-target="#carouselOwner{{ business.id }}" data-bs-slide="next">
                                        <span class="carousel-control-next-icon"></span>
                                    </button>
                                {% endif %}
                            </div>

                        {% else %}
                            <img src="{{ asset('images/default-business.png') }}"
                                 class="card-img-top"
                                 alt="{{ business.name }}">
                        {% endif %}

                        <div class="card-body">
                            <h5 class="card-title">{{ business.name }}</h5>
                            <p class="card-text">{{ business.description|default('Pas de description') }}</p>
                        </div>

                    </div>
                </div>
            {% else %}
                <p>Aucun commerce pour cet utilisateur.</p>
            {% endfor %}
        </div>
    </div>


    {# --- MODAL --- #}
    <div class="modal fade" id="businessModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content" id="modal-content-area">
                <!-- contenu AJAX -->
            </div>
        </div>
    </div>

    {% block javascripts %}
        <script>

    document.querySelectorAll(".business-card").forEach(card => {
    card.addEventListener("click", function () {
    const id = this.dataset.id;

    fetch("/business/" + id)
    .then(response => response.text())
    .then(html => {
    document.getElementById("modal-content-area").innerHTML = html;

    const modal = new bootstrap.Modal(document.getElementById("businessModal"));
    modal.show();

    attachFileUploadEvents();
    });
    });
    });



    function handlePhotoUpload(input, businessId) {
    const container = document.getElementById(`filePreviews${businessId}`);
    const countElement = document.getElementById(`photoCount${businessId}`);
    const form = input.closest("form");

    if (!container) return;

    container.innerHTML = "";
    container.classList.add("d-none");
    countElement.textContent = "";

    let files = Array.from(input.files);

    // max 5
    const limited = files.slice(0, 5);
    if (files.length > 5) {
    alert("Limite de 5 images atteinte.");
    }

    limited.forEach((file, index) => {
    if (!file.type.startsWith("image/")) return;

    const reader = new FileReader();
    reader.onload = e => {
    const preview = document.createElement("div");
    preview.className = "photo-preview";
    preview.innerHTML = `
    <img src="${e.target.result}">
    <button type="button"
            class="remove-photo"
            onclick="removePhoto(this, ${index}, '${businessId}')">
        &times;
    </button>
    `;

    container.appendChild(preview);
    };

    reader.readAsDataURL(file);
    });

    container.classList.remove("d-none");
    countElement.innerHTML = `<i class="bi bi-images me-1"></i> ${limited.length} image(s) sélectionnée(s)`;
    countElement.classList.add("text-primary", "fw-medium");
    }



    window.removePhoto = function (btn, index, businessId) {
    const container = document.getElementById(`filePreviews${businessId}`);
    const previews = container.querySelectorAll(".photo-preview");

    if (previews[index]) {
    previews[index].remove();
    }

    const remaining = container.querySelectorAll(".photo-preview").length;
    const countElement = document.getElementById(`photoCount${businessId}`);

    if (remaining === 0) {
    container.classList.add("d-none");
    countElement.textContent = "";
    } else {
    countElement.innerHTML = `<i class="bi bi-images me-1"></i> ${remaining} image(s) sélectionnée(s)`;
    }
    };


    function attachFileUploadEvents() {
    const inputs = document.querySelectorAll('input[type="file"][id^="photosInput"]');

    inputs.forEach(input => {
    const businessId = input.id.replace("photosInput", "");
    input.addEventListener("change", function () {
    handlePhotoUpload(this, businessId);
    });
    });
    }

    </script>
{% endblock %}

{% endblock %}
